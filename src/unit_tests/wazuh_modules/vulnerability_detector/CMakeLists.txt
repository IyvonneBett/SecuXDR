# Generate vulnerability detector library
file(GLOB vulndetector_files
    ${SRC_FOLDER}/wazuh_modules/*.o
    ${SRC_FOLDER}/wazuh_modules/vulnerability_detector/*.o)
list(REMOVE_ITEM vulndetector_files ${SRC_FOLDER}/wazuh_modules/main.o)

add_library(VULNDETECTOR_O STATIC ${vulndetector_files})

set_source_files_properties(
    ${vulndetector_files}
    PROPERTIES
    EXTERNAL_OBJECT true
    GENERATED true
)

set_target_properties(
    VULNDETECTOR_O
    PROPERTIES
    LINKER_LANGUAGE C
)

target_link_libraries(VULNDETECTOR_O ${WAZUHLIB} ${WAZUHEXT} -lpthread)

#include wrappers
include(${SRC_FOLDER}/unit_tests/wrappers/wazuh/shared/shared.cmake)

# Generate vulnerability detector tests
list(APPEND vulndetector_names "test_wm_vuln_detector")
list(APPEND vulndetector_flags "-Wl,--wrap,_merror -Wl,--wrap,_mterror -Wl,--wrap,_mtdebug1 -Wl,--wrap,_mtdebug2 -Wl,--wrap,OS_ConnectUnixDomain \
                                -Wl,--wrap,OS_SendSecureTCP -Wl,--wrap,OS_RecvSecureTCP -Wl,--wrap,close -Wl,--wrap,sqlite3_prepare_v2 \
                                -Wl,--wrap,sqlite3_bind_text -Wl,--wrap,sqlite3_bind_int -Wl,--wrap,sqlite3_step -Wl,--wrap,sqlite3_close_v2 \
                                -Wl,--wrap,sqlite3_finalize -Wl,--wrap,sqlite3_errmsg -Wl,--wrap,cJSON_CreateObject -Wl,--wrap,cJSON_CreateArray \
                                -Wl,--wrap,StartMQ -Wl,--wrap,SendMSG -Wl,--wrap,strerror \
                                -Wl,--wrap,_mterror_exit -Wl,--wrap,sqlite3_column_text -Wl,--wrap,sqlite3_column_double \
                                -Wl,--wrap,cJSON_Delete -Wl,--wrap,cJSON_AddItemToObject -Wl,--wrap,cJSON_AddStringToObject -Wl,--wrap,cJSON_CreateNumber \
                                -Wl,--wrap,cJSON_CreateString -Wl,--wrap,cJSON_AddItemToArray -Wl,--wrap,cJSON_PrintUnformatted \
                                -Wl,--wrap,pkg_version_relate -Wl,--wrap,cJSON_Parse -Wl,--wrap,cJSON_GetObjectItem \
                                -Wl,--wrap,_mtwarn -Wl,--wrap,sqlite3_column_int -Wl,--wrap,wm_vuldet_win_nvd_vulnerabilities \
                                -Wl,--wrap,wm_vuldet_linux_nvd_vulnerabilities -Wl,--wrap,cJSON_AddNumberToObject \
                                -Wl,--wrap,_mdebug1 -Wl,--wrap,_mdebug2 -Wl,--wrap,time -Wl,--wrap,wstr_end -Wl,--wrap=fgetc \
                                -Wl,--wrap,json_fread -Wl,--wrap,remove -Wl,--wrap,fopen -Wl,--wrap,fclose -Wl,--wrap,wurl_request -Wl,--wrap,sleep \
                                -Wl,--wrap,sqlite3_open_v2 -Wl,--wrap,fgets -Wl,--wrap,fwrite -Wl,--wrap,localtime -Wl,--wrap,OS_GetOneContentforElement \
                                -Wl,--wrap,OS_ReadXML -Wl,--wrap,OS_ReadXML_Ex -Wl,--wrap,OS_GetElementsbyNode -Wl,--wrap,OSRegex_Compile -Wl,--wrap,OSRegex_Execute \
                                -Wl,--wrap,w_get_file_content -Wl,--wrap,wm_vuldet_json_nvd_parser -Wl,--wrap,wm_vuldet_json_wcpe_parser \
                                -Wl,--wrap,wm_vuldet_json_msu_parser -Wl,--wrap,opendir -Wl,--wrap,closedir -Wl,--wrap,readdir -Wl,--wrap,w_is_file \
                                -Wl,--wrap,fflush -Wl,--wrap,fprintf -Wl,--wrap,fread -Wl,--wrap,fseek -Wl,--wrap,getpid \
                                -Wl,--wrap,wurl_request_uncompress_bz2_gz -Wl,--wrap,w_uncompress_bz2_gz_file -Wl,--wrap,wstr_replace \
                                -Wl,--wrap,OSHash_Delete_ex -Wl,--wrap=wstr_split -Wl,--wrap,OSMatch_Execute -Wl,--wrap,OSRegex_Execute_ex \
                                -Wl,--wrap,fgetpos -Wl,--wrap,wdb_insert_vuln_cves -Wl,--wrap,wdb_get_all_agents \
                                -Wl,--wrap,OS_ClearXML -Wl,--wrap,wdb_remove_vuln_cves_by_status -Wl,--wrap,cJSON_GetStringValue -Wl,--wrap,wm_sendmsg \
                                -Wl,--wrap,wdb_update_vuln_cves_status -Wl,--wrap,cJSON_ParseWithOpts ${HASH_OP_WRAPPERS}")

list(APPEND vulndetector_names "test_wm_vuln_detector_evr")
list(APPEND vulndetector_flags "-Wl,--wrap,_merror -Wl,--wrap,_mterror -Wl,--wrap,_mtdebug1 -Wl,--wrap,_mtdebug2 -Wl,--wrap,OS_ConnectUnixDomain \
                                -Wl,--wrap,OS_SendSecureTCP -Wl,--wrap,OS_RecvSecureTCP -Wl,--wrap,close -Wl,--wrap,sqlite3_prepare_v2 \
                                -Wl,--wrap,sqlite3_bind_text -Wl,--wrap,sqlite3_bind_int -Wl,--wrap,sqlite3_step -Wl,--wrap,sqlite3_close_v2 \
                                -Wl,--wrap,sqlite3_finalize -Wl,--wrap,sqlite3_errmsg -Wl,--wrap,cJSON_CreateObject -Wl,--wrap,cJSON_CreateArray \
                                -Wl,--wrap,StartMQ -Wl,--wrap,SendMSG -Wl,--wrap,strerror \
                                -Wl,--wrap,_mterror_exit -Wl,--wrap,c_isdigit -Wl,--wrap,fopen -Wl,--wrap,fclose -Wl,--wrap,fgets -Wl,--wrap,fwrite \
                                -Wl,--wrap,OSRegex_Compile -Wl,--wrap,OSRegex_Execute,--wrap,fflush -Wl,--wrap,fprintf -Wl,--wrap,fread -Wl,--wrap,fseek \
                                -Wl,--wrap,remove -Wl,--wrap,getpid -Wl,--wrap,fgetpos -Wl,--wrap=fgetc")

list(APPEND vulndetector_names "test_wm_vuln_detector_nvd")
list(APPEND vulndetector_flags "-Wl,--wrap,_merror -Wl,--wrap,_mterror -Wl,--wrap,_mtdebug1 -Wl,--wrap,_mtdebug2 -Wl,--wrap,close -Wl,--wrap,sqlite3_prepare_v2 \
                                -Wl,--wrap,sqlite3_bind_text -Wl,--wrap,sqlite3_bind_int -Wl,--wrap,sqlite3_step -Wl,--wrap,sqlite3_close_v2 \
                                -Wl,--wrap,sqlite3_finalize -Wl,--wrap,sqlite3_errmsg -Wl,--wrap,strerror -Wl,--wrap,_mterror_exit -Wl,--wrap,sqlite3_column_int \
                                -Wl,--wrap,wm_checks_package_vulnerability -Wl,--wrap,sqlite3_column_text -Wl,--wrap,wm_vuldet_add_cve_node \
                                -Wl,--wrap,fopen -Wl,--wrap,fclose -Wl,--wrap,fgets -Wl,--wrap,fwrite -Wl,--wrap=fgetc\
                                -Wl,--wrap,OSRegex_Compile -Wl,--wrap,OSRegex_Execute,--wrap,fflush -Wl,--wrap,fprintf -Wl,--wrap,fread -Wl,--wrap,fseek \
                                -Wl,--wrap,remove -Wl,--wrap,getpid -Wl,--wrap,OSMatch_Execute -Wl,--wrap,OSRegex_Execute_ex -Wl,--wrap,fgetpos")

list(APPEND vulndetector_names "test_wm_vuln_detector_run_now")
list(APPEND vulndetector_flags " ")

# Compilig tests
list(LENGTH vulndetector_names count)
math(EXPR count "${count} - 1")
foreach(counter RANGE ${count})
    list(GET vulndetector_names ${counter} test_name)
    list(GET vulndetector_flags ${counter} test_flags)

    add_executable(${test_name} ${test_name}.c mocks_wm_vuln_detector.c)

    target_link_libraries(
        ${test_name}
        ${WAZUHLIB}
        ${WAZUHEXT}
        VULNDETECTOR_O
        ${TEST_DEPS}
    )

    if(NOT test_flags STREQUAL " ")
        target_link_libraries(
            ${test_name}
            ${test_flags}
        )
    endif()
    add_test(NAME ${test_name} COMMAND ${test_name})
endforeach()
